---
// Props interface
interface Props {
  serverURL: string;
  lang?: string;
  dark?: string;
  emoji?: string[];
  meta?: string[];
  requiredMeta?: string[];
  reaction?: boolean;
  pageview?: boolean;
}

const {
  serverURL,
  lang = "en",
  dark = "html[data-theme-type='dark']",
  emoji = ["https://unpkg.com/@waline/emojis@1.1.0/weibo", "https://unpkg.com/@waline/emojis@1.1.0/bilibili"],
  meta = ["nick", "mail", "link"],
  requiredMeta = [],
  reaction = false,
  pageview = false,
} = Astro.props;
---

<div id="waline-container"></div>

<link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />

<script
  type="module"
  define:vars={{
    serverURL,
    lang,
    dark,
    emoji,
    meta,
    requiredMeta,
    reaction,
    pageview,
  }}
>
  import { init } from "https://unpkg.com/@waline/client@v3/dist/waline.js";

  let waline;

  // 初始化Waline评论系统
  async function initWaline() {
    const container = document.getElementById('waline-container');
    if (!container) return;

    // 销毁旧实例（如果存在）
    if (waline) {
      try {
        await waline.destroy();
      } catch (err) {
        console.error('Failed to destroy Waline instance:', err);
      }
    }
    
    // 创建新实例
    try {
      waline = init({
        el: container,
        serverURL,
        path: location.pathname,
        lang,
        dark,
        emoji,
        meta,
        requiredMeta,
        reaction,
        pageview,
      });
    } catch (err) {
      console.error('Failed to initialize Waline:', err);
    }
  }

  // 初始化逻辑：立即执行一次，然后监听关键事件
  initWaline();

  // 监听路由切换和页面可见性变化
  ['astro:after-swap', 'visibilitychange'].forEach(event => {
    document.addEventListener(event, () => {
      // 页面可见性变化时，只有在页面可见的情况下才初始化
      if (event === 'visibilitychange' && document.hidden) return;
      initWaline();
    });
  });
</script>

<style>
  #waline-container {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
</style>
